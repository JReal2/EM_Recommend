{{>layouts/header}}

<div id="back_ground">
    <form id="data_input" class="container" action="/em/info" method="post"
          style="background-color: white; padding: 30px; width: 30%; border-radius: 8px; ">
        <div class="mb-3">
            <label class="form-label">위도</label>
            <input id="latitude" type="text" class="form-control" name="lat">
        </div>
        <div class="mb-3">
            <label class="form-label">경도</label>
            <input id="longitude" type="text" class="form-control" name="lon">
        </div>
        <div class="mb-3">
            <label class="form label">상태</label>
            <textarea id="status" class="form-control" name="status" rows="5"></textarea>
        </div>
        <button type="submit" class="btn btn-primary">Submit</button>
    </form>

    <form id="data_audio" class="container" action="/em/upload" method="post" enctype="multipart/form-data"
          style="background-color: white; padding: 30px; width: 30%; border-radius: 8px; ">
        <div class="mb-3">
            <label class="form-label">위도</label>
            <input id="latitude2" type="text" class="form-control" name="lat">
        </div>
        <div class="mb-3">
            <label class="form-label">경도</label>
            <input id="longitude2" type="text" class="form-control" name="lon">
        </div>
        <div class="mb-3">
            <label class="form-label">음성 파일</label>
            <label class="form-label" for="audioFile" id="audioFileLabel" style="display:none;">녹음 완료</label>
            <input id="audioFile" type="file" class="form-control" name="file" accept="audio/mp3" style="display: none">
        </div>
        <button id="startBtn" type="button">Start Recording</button>
        <button id="stopBtn"  type="button" disabled>Stop Recording</button>
        <button type="submit" class="btn btn-primary">Submit</button>

    </form>

</div>
<script>
    let mediaRecorder;
    let audioChunks = [];
    const startBtn = document.getElementById("startBtn");
    const stopBtn = document.getElementById("stopBtn");
    const latitudeInput = document.getElementById("latitude2");
    const longitudeInput = document.getElementById("longitude2");
    const audioFileInput = document.getElementById("audioFile");
    const audioFileLabel = document.getElementById("audioFileLabel");

    startBtn.addEventListener("click", async () => {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        mediaRecorder = new MediaRecorder(stream);

        mediaRecorder.ondataavailable = (event) => {
            audioChunks.push(event.data);
        };

        mediaRecorder.onstop = async () => {
            const audioBlob = new Blob(audioChunks, { type: 'audio/mp3' });
            const audioFile = new File([audioBlob], "recording.mp3", { type: "audio/mp3" });

            // 위도, 경도 값 가져오기
            const lat = latitudeInput.value;
            const lon = longitudeInput.value;

            if (!lat || !lon) {
                alert("위도와 경도를 입력하세요.");
                return;
            }

            // 음성 파일을 input에 동적으로 추가
            const dataTransfer = new DataTransfer();
            dataTransfer.items.add(audioFile); // 음성 파일을 추가
            audioFileInput.files = dataTransfer.files; // input에 파일 설정
            audioFileLabel.style.display = "block";
            // 폼을 제출
            //document.getElementById("data_audio").submit();

            // 초기화
            audioChunks = [];
        };

        mediaRecorder.start();
        startBtn.disabled = true;
        stopBtn.disabled = false;
    });

    stopBtn.addEventListener("click", () => {
        mediaRecorder.stop();
        startBtn.disabled = false;
        stopBtn.disabled = true;
    });
</script>
{{>layouts/footer}}